---
- name: Deploying Review Radar on the kubernetes cluster
  hosts: localhost
  remote_user: riya
  become: false
  tasks:
    - name: Ensure Kubernetes context is set
      ansible.builtin.shell: |
        export KUBECONFIG=/var/lib/jenkins/.minikube/profiles/minikube/config
        kubectl config use-context minikube

    - name: Deleting older application files
      ansible.builtin.shell: |
        export KUBECONFIG=/var/lib/jenkins/.minikube/profiles/minikube/config
        kubectl delete -f ../manifest/mysql-deployment.yml -n my-app --ignore-not-found=true
        kubectl delete -f ../manifest/backend-deployment.yml -n my-app --ignore-not-found=true
        kubectl delete -f ../manifest/frontend-deployment.yml -n my-app --ignore-not-found=true
        kubectl delete -f ../manifest/my-ingress.yml -n my-app --ignore-not-found=true
        
    - name: Deploying application to kubernetes cluster
      ansible.builtin.shell: |
        export KUBECONFIG=/var/lib/jenkins/.minikube/profiles/minikube/config
        kubectl create namespace my-app || true
        kubectl config set-context --current --namespace=my-app
        kubectl apply -f ../manifest/mysql-deployment.yml -n my-app
        kubectl apply -f ../manifest/backend-deployment.yml -n my-app
        kubectl apply -f ../manifest/frontend-deployment.yml -n my-app
        kubectl apply -f ../manifest/my-ingress.yml -n my-app

    - name: Wait for backend pod to be ready
      ansible.builtin.shell: |
        export KUBECONFIG=/var/lib/jenkins/.minikube/profiles/minikube/config
        kubectl wait --for=condition=ready pod -l app=backend -n my-app --timeout=120s

    - name: Port forward backend service
      ansible.builtin.shell: |
        export KUBECONFIG=/var/lib/jenkins/.minikube/profiles/minikube/config
        nohup kubectl port-forward service/backend 8085:8085 -n my-app &

